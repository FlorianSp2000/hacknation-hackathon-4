Bootstrap: docker
From: nvidia/cuda:12.4.1-runtime-ubuntu22.04

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    apt-get update
    apt-get install -y software-properties-common
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y \
        python3.12 python3.12-dev python3.12-venv \
        git curl wget ca-certificates \
        libgl1-mesa-glx libglib2.0-0 libsm6 libxrender1 libxext6 \
        ffmpeg

    # Set python3.12 as default
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1
    update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1

    # Install uv for fast dependency resolution
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="/root/.local/bin:$PATH"

    # Create app venv and install dependencies
    uv venv /opt/venv --python python3.12
    export VIRTUAL_ENV=/opt/venv
    export PATH="/opt/venv/bin:$PATH"

    # Install PyTorch with CUDA 12.4 (needs separate index URL)
    uv pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124

    # Install remaining deps (torch already installed above)
    uv pip install \
        "streamlit>=1.30" \
        "transformers @ git+https://github.com/huggingface/transformers@2a5ba8b53d298ed8421e09831bf96bb6d056a24d" \
        "ultralytics>=8.0" \
        "opencv-python>=4.8" \
        "numpy>=1.24" \
        "Pillow>=10.0" \
        "accelerate" \
        "mediapipe>=0.10.14" \
        "rfdetr" \
        "onnxruntime" \
        "streamlit-webrtc>=0.47"
    rm -rf /tmp/build

    # Cleanup
    apt-get clean
    rm -rf /var/lib/apt/lists/* /root/.cache

%environment
    export PATH="/opt/venv/bin:$PATH"
    export VIRTUAL_ENV=/opt/venv
    export PYTHONPATH=/app:$PYTHONPATH
    export HF_HOME=/app/cache/huggingface
    export TORCH_HOME=/app/cache/torch

%runscript
    exec python -m streamlit run /app/app.py --server.port=8501 --server.address=0.0.0.0 "$@"
